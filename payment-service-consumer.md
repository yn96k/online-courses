## Алгоритм обработки сообщения на консьюмере сервиса платежей

### Входные данные

| Поле                 | Для чего нужно                                                                                   |
| -------------------- | ------------------------------------------------------------------------------------------------ |
| user_id              | Уникальный идентификатор пользователя, к которому относится событие                              |
| op                   | Тип операции с пользователем (CREATE, UPDATE, DELETE), определяет действие                       |
| payload.id           | Идентификатор пользователя внутри полезной нагрузки события                                      |
| payload.email        | Электронная почта пользователя, может использоваться для уведомлений и аутентификации            |
| payload.first_name   | Имя пользователя, используется для отображения и персонализации                                  |
| payload.last_name    | Фамилия пользователя, используется для отображения и персонализации                              |
| payload.role         | Роль пользователя, определяет уровень доступа и права                                            |
| payload.phone_number | Контактный номер телефона пользователя                                                           |
| payload.updated_at   | Время последнего обновления данных пользователя                                                  |
| version              | Версия события, нужна для обеспечения согласованности и идемпотентной обработки                  |
| updated_at           | Время обновления самого события, используется для синхронизации и порядка обработки              |
| trace_id             | Идентификатор трассировки, помогает связывать события с цепочками запросов или операций          |
| metadata             | Дополнительные данные о событии в виде пар ключ-значение, например источник события или контекст |

1. Чтение операции op
2. Валидация полей объекта: user_id, op, payload, version
3. Генерация ключа для кэша на основе user_id или комбинации user_id + version
4. Подготовка значения для кэша: сериализация payload или всего события
5. Установка TTL
6. Запись ключа и значения в кэш

| Поле в кэше        | Тип данных / формат           | Описание                                                               |
| ------------------ | ----------------------------- | ---------------------------------------------------------------------- |
| key                | string                        | Ключ кэша, например `user:{user_id}` или `user:{user_id}:v{version}`   |
| value              | JSON / сериализованный объект | Полезная нагрузка события `payload` или весь объект `UserEvent`        |
| value.user_id      | string                        | Идентификатор пользователя                                             |
| value.email        | string                        | Электронная почта пользователя                                         |
| value.first_name   | string                        | Имя пользователя                                                       |
| value.last_name    | string                        | Фамилия пользователя                                                   |
| value.role         | string                        | Роль пользователя                                                      |
| value.phone_number | string                        | Телефон пользователя                                                   |
| value.updated_at   | string / ISO 8601             | Время последнего обновления данных пользователя                        |
| value.op           | string / enum                 | Тип операции события (`CREATE`, `UPDATE`, `DELETE`)                    |
| value.version      | int64                         | Версия события для идемпотентной обработки                             |
| value.trace_id     | string                        | Идентификатор трассировки события                                      |
| value.metadata     | map<string, string>           | Дополнительные данные события                                          |
| ttl                | int / timestamp               | Время жизни записи в кэше (опционально, для автоматического истечения) |

### Ошибки

| Пункт алгоритма | Ошибка                                         | Действия                                                                                             |
| --------------- | ---------------------------------------------- | ---------------------------------------------------------------------------------------------------- |
| 1               | Некорректное или отсутствующее значение `op`   | Логировать ошибку, отбросить сообщение, при необходимости отправка в DLQ                             |
| 2               | Отсутствует `user_id`, `payload` или `version` | Логировать ошибку, отбросить сообщение, отправка в DLQ                                               |
| 3               | Ошибка генерации ключа для кэша                | Логировать ошибку, использовать резервный алгоритм формирования ключа, при невозможности — отклонить |
| 4               | Ошибка сериализации `payload` или `UserEvent`  | Логировать ошибку, отбросить сообщение, при необходимости отправка в DLQ                             |
| 5               | Некорректное или отсутствующее значение TTL    | Применить значение по умолчанию, логировать предупреждение                                           |
| 6               | Ошибка записи ключа и значения в кэш           | Повторная попытка записи, логирование, при повторной неудаче — отправка в DLQ                        |




