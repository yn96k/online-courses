## Алгоритм обработки сообщения на консьюмере сервиса платежей
Описывает логику сервиса платежей после чтения сообщения в топике users. Цель - обновление кэша, в котором сервис платежей хранит последние изменения в базе данных сервиса профилей для быстрого доступа к ним  

### Входные данные
[userdata.proto](https://github.com/yn96k/online-courses/blob/3e510ddc7500659f2d2b1ce8550b52c5580fe53f/kafka-topic-userdata.proto)
| Поле                 | Для чего нужно                                                                                   |
| -------------------- | ------------------------------------------------------------------------------------------------ |
| user_id              | Уникальный идентификатор пользователя, к которому относится событие                              |
| op                   | Тип операции с пользователем (CREATE, UPDATE, DELETE), определяет действие                       |
| payload.id           | Идентификатор пользователя внутри полезной нагрузки события                                      |
| payload.email        | Электронная почта пользователя, может использоваться для уведомлений и аутентификации            |
| payload.first_name   | Имя пользователя, используется для отображения и персонализации                                  |
| payload.last_name    | Фамилия пользователя, используется для отображения и персонализации                              |
| payload.role         | Роль пользователя, определяет уровень доступа и права                                            |
| payload.phone_number | Контактный номер телефона пользователя                                                           |
| payload.updated_at   | Время последнего обновления данных пользователя                                                  |
| version              | Версия события, нужна для обеспечения согласованности и идемпотентной обработки                  |
| updated_at           | Время обновления самого события, используется для синхронизации и порядка обработки              |
| trace_id             | Идентификатор трассировки, помогает связывать события с цепочками запросов или операций          |
| metadata             | Дополнительные данные о событии в виде пар ключ-значение, например источник события или контекст |

- Чтение операции op:
   - Если op не равен 1,2,3 - логировать ошибку, отбросить сообщение и отправить в DLQ <br>
- 1 (CREATE): <br>
   1. Валидация полей объекта (user_id, payload, version) - чтение из кэша: <br>
      - Если нет payload или version - логировать ошибку, отбросить сообщение и отправить в DLQ <br>
      - Если user_id уже есть - логировать ошибку, отбросить сообщение и отправить в DLQ <br>
   2. Генерация ключа для кэша на основе user_id <br>
      - Если не удалось сгенерировать ключ - логировать ошибку, отбросить сообщение и отправить в DLQ <br>
   3. Запись ключа и значения в кэш<br>
- 2 (UPDATE): <br>
   1. Валидация полей объекта (user_id, payload, version) - чтение из кэша: <br>
      - Если нет каких-либо полей - логировать ошибку, отбросить сообщение и отправить в DLQ <br>
   2. Запись ключа и значения в кэш<br>
- 3 (DELETE): <br>
   1. Валидация полей объекта (user_id, payload, version) - чтение из кэша: <br>
      - Если нет user_id или version - логировать ошибку, отбросить сообщение и отправить в DLQ <br>
      - Если payload есть - логировать ошибку, отбросить сообщение и отправить в DLQ <br>
   2. Удаление записи с user_id из кэша <br>

### Правила формирования записи в кэше (для CREATE и UPDATE)
| Поле в кэше        | Тип данных / формат           | Описание                                                               |
| ------------------ | ----------------------------- | ---------------------------------------------------------------------- |
| key                | string                        | Ключ кэша `user:{user_id}`                                             |
| value              | JSON / сериализованный объект | Полезная нагрузка события `payload` или весь объект `UserEvent`        |
| value.user_id      | string                        | Идентификатор пользователя                                             |
| value.email        | string                        | Электронная почта пользователя                                         |
| value.first_name   | string                        | Имя пользователя                                                       |
| value.last_name    | string                        | Фамилия пользователя                                                   |
| value.role         | string                        | Роль пользователя                                                      |
| value.phone_number | string                        | Телефон пользователя                                                   |
| value.updated_at   | string / ISO 8601             | Время последнего обновления данных пользователя                        |
| value.version      | int64                         | Версия события для идемпотентной обработки                             |


