## Алгоритм обработки запроса POST /user в сервисе пользователей

### Входные данные

| Поле                | Тип данных                 | Ограничения / Описание                                       |
|---------------------|----------------------------|--------------------------------------------------------------|
| login               | VARCHAR(20)                    | NOT NULL, уникальное значение                                |
| first_name          | VARCHAR(20)                    | NULLABLE                                                     |
| last_name           | VARCHAR(20)                    | NULLABLE                                                     |
| middle_name         | VARCHAR(20)                    | NULLABLE                                                     |
| email               | VARCHAR(254)                    | NOT NULL, уникальное значение, формат e-mail                 |
| password            | VARCHAR(20)                    | NOT NULL, минимальная длина 8 символов                       |
| phone_number        | VARCHAR(15)                    | NULLABLE, формат: E.164 (например, `+79211009802`)           |
| role                | ENUM('user','author','admin') | NOT NULL, DEFAULT 'user'                                  |
| avatar_url          | VARCHAR(100)                    | NULLABLE, формат URL                                         |
| notifications_email | ENUM('all','important','none') | NOT NULL, DEFAULT 'all'                                   |
| notifications_push  | ENUM('all','important','none') | NOT NULL, DEFAULT 'all'                                   |
| terms               | BOOLEAN[2] (ARRAY)          | NOT NULL, соответствует [согласие_с_сервисом, согласие_с_политикой] |

### Выходные данные

| Поле          | Описание                                                                           |
| ------------- | ---------------------------------------------------------------------------------- |
| user_id       | Уникальный идентификатор пользователя, используемый для идентификации в системе    |
| role          | Роль пользователя (например, 'user', 'admin'), определяет уровень доступа          |
| creation_date | Дата и время создания пользователя, указывается в формате ISO 8601 или аналогичном |

### Алгоритм работы

1. Логическая проверка данных <br>
1.1. Проверить уникальность поля login: <br>
- Произвести поиск в базе данных по полному совпадению по полю login: <br>
а. Если БД возвращает запись - прекратить выполнение <br>
б. Если БД не возвращает ни одной записи - продолжить <br>
1.2. Проверить уникальность поля email <br>
- Произвести поиск в базе данных по полному совпадению по полю email <br>
а. Если БД возвращает запись - прекратить выполнение <br>
б. Если БД не возвращает ни одной записи - продолжить <br>
2. Сгенерировать хеш на основе поля password
3. Вставить запись в БД:

| Поле                | Чем заполнять                                                       |
| ------------------- | ------------------------------------------------------------------- |
| login               | Уникальное текстовое значение, используемое для входа               |
| first_name          | Имя пользователя                                                    |
| last_name           | Фамилия пользователя                                                |
| middle_name         | Отчество пользователя (может быть NULL)                             |
| email               | Электронная почта, уникальная                                       |
| email_verified      | Логическое значение (True/False), по умолчанию False                |
| password_hash       | Хеш пароля пользователя (не хранить в открытом виде)                |
| phone_number        | Номер телефона в стандартизированном формате (может быть NULL)      |
| role                | Роль пользователя (например, 'user', 'admin')                       |
| ban                 | NULL                                                                |
| avatar_url          | Ссылка на аватар пользователя (может быть NULL)                     |
| last_visit          | Дата и время последнего визита, по умолчанию CURRENT_TIMESTAMP      |
| created_at          | Дата и время создания записи, по умолчанию CURRENT_TIMESTAMP        |
| updated_at          | Дата и время последнего обновления, по умолчанию CURRENT_TIMESTAMP  |
| notifications_email | Логическое значение (True/False) для получения уведомлений на почту |
| notifications_push  | Логическое значение (True/False) для получения push-уведомлений     |

4. Отправка сообщения в брокер 
- [userdata.proto](https://github.com/yn96k/online-courses/blob/3e510ddc7500659f2d2b1ce8550b52c5580fe53f/kafka-topic-userdata.proto)

| Поле                 | Данные                                                                                                                                                     |
| -------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------- |
| user_id              | Уникальный идентификатор созданного пользователя                                                                                                           |
| op                   | 2                                                                                                                                                  |
| payload.id           | Идентификатор пользователя из тела запроса                                                                                                                 |
| payload.email        | email из тела запроса                                                                                                                                      |
| payload.first_name   | first_name из тела запроса                                                                                                                                        |
| payload.last_name    | last_name из тела запроса                                                                                                                                    |
| payload.role         | role  из тела запроса                                                                       |
| payload.phone_number | Телефон из тела запроса                                                                                                                                    |
| payload.updated_at   | Текущий таймстамп (в формате ISO 8601)                                                                                                                     |
| updated_at           | Текущий таймстамп (в формате Timestamp protobuf)                                                                                                           |
| trace_id             | Значение из заголовка `X-Trace-ID` запроса                                                                                                  |

5. Формирование HTTP-ответа на запрос
### Ошибки

| Error code | error-message        | Сообщение ошибки                                |
| ---------- | -------------------- | ----------------------------------------------- |
| 409        | duplicate_login      | Пользователь с таким логином уже существует     |
| 409        | duplicate_email      | Пользователь с таким email уже зарегистрирован  |
| 500        | db_insert_failed     | Не удалось добавить пользователя в базу данных  |
| 502        | broker_send_failed   | Не удалось отправить сообщение в брокер событий |
| 403        | forbidden_origin     | Запрос не прошёл проверку доверенного источника |

