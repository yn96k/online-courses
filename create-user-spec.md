## Алгоритм обработки запроса POST /user в сервисе пользователей

### Входные данные

| Поле                | Тип данных                 | Ограничения / Описание                                       |
|---------------------|----------------------------|--------------------------------------------------------------|
| login               | VARCHAR(20)                    | NOT NULL, уникальное значение                                |
| first_name          | VARCHAR(20)                    | NULLABLE                                                     |
| last_name           | VARCHAR(20)                    | NULLABLE                                                     |
| middle_name         | VARCHAR(20)                    | NULLABLE                                                     |
| email               | VARCHAR(254)                    | NOT NULL, уникальное значение, формат e-mail                 |
| password            | VARCHAR(20)                    | NOT NULL, минимальная длина 8 символов                       |
| phone_number        | VARCHAR(15)                    | NULLABLE, формат: E.164 (например, `+79211009802`)           |
| role                | ENUM('user','author','admin') | NOT NULL, DEFAULT 'user'                                  |
| avatar_url          | VARCHAR(100)                    | NULLABLE, формат URL                                         |
| notifications_email | ENUM('all','important','none') | NOT NULL, DEFAULT 'all'                                   |
| notifications_push  | ENUM('all','important','none') | NOT NULL, DEFAULT 'all'                                   |
| terms               | BOOLEAN[2] (ARRAY)          | NOT NULL, соответствует [согласие_с_сервисом, согласие_с_политикой] |

### Выходные данные

| Поле          | Описание                                                                           |
| ------------- | ---------------------------------------------------------------------------------- |
| user_id       | Уникальный идентификатор пользователя, используемый для идентификации в системе    |
| role          | Роль пользователя (например, 'user', 'admin'), определяет уровень доступа          |
| creation_date | Дата и время создания пользователя, указывается в формате ISO 8601 или аналогичном |

### Алгоритм работы

1. Логическая проверка данных <br>
1.1. Проверить уникальность поля login <br>
1.2. Проверить уникальность поля email <br>
2. Сгенерировать хеш на основе поля password
3. Вставить запись в БД:

| Поле                | Чем заполнять                                                       |
| ------------------- | ------------------------------------------------------------------- |
| login               | Уникальное текстовое значение, используемое для входа               |
| first_name          | Имя пользователя                                                    |
| last_name           | Фамилия пользователя                                                |
| middle_name         | Отчество пользователя (может быть NULL)                             |
| email               | Электронная почта, уникальная                                       |
| email_verified      | Логическое значение (True/False), по умолчанию False                |
| password_hash       | Хеш пароля пользователя (не хранить в открытом виде)                |
| phone_number        | Номер телефона в стандартизированном формате (может быть NULL)      |
| role                | Роль пользователя (например, 'user', 'admin')                       |
| ban                 | NULL                                                                |
| avatar_url          | Ссылка на аватар пользователя (может быть NULL)                     |
| last_visit          | Дата и время последнего визита, по умолчанию CURRENT_TIMESTAMP      |
| created_at          | Дата и время создания записи, по умолчанию CURRENT_TIMESTAMP        |
| updated_at          | Дата и время последнего обновления, по умолчанию CURRENT_TIMESTAMP  |
| notifications_email | Логическое значение (True/False) для получения уведомлений на почту |
| notifications_push  | Логическое значение (True/False) для получения push-уведомлений     |

4. Формирование HTTP-ответа на запрос
5. Запись HTTP-ответа с ключом идемпотентности в кэш

| Поле             | Описание                                                                                 |
| ---------------- | ---------------------------------------------------------------------------------------- |
| idempotency_key  | Уникальный ключ, идентифицирующий конкретный HTTP-запрос для обеспечения идемпотентности |
| request_method   | HTTP-метод запроса (GET, POST, PUT, DELETE и т.д.)                                       |
| request_url      | URL, на который был отправлен запрос                                                     |
| request_headers  | Заголовки запроса в виде словаря или JSON                                                |
| request_body     | Тело запроса (если есть), например JSON или form-data                                    |
| response_status  | HTTP-статус, полученный в ответ на запрос                                                |
| response_headers | Заголовки ответа, возвращённые сервером                                                  |
| response_body    | Тело ответа сервера, сохранённое для повторного использования                            |
| created_at       | Время создания записи в кэше                                                             |
| expires_at       | Время истечения срока действия кэшированной записи, после которого ключ можно удалить    |

6. Отправка сообщения в брокер 
- [userdata.proto](https://github.com/yn96k/online-courses/blob/3e510ddc7500659f2d2b1ce8550b52c5580fe53f/kafka-topic-userdata.proto)

```protobuf

syntax = "proto3";

package users.events;

import "google/protobuf/timestamp.proto";

message User {
  string id = 1;
  string email = 2;
  string first_name = 3;
  string last_name = 4;
  string role = 5;
  string phone_number = 6;
  string updated_at = 7;
}

enum OpType {
  OP_UNSPECIFIED = 0;
  CREATE = 1;
  UPDATE = 2;
  DELETE = 3;
}

message UserEvent {
  string user_id = 1;
  OpType op = 2;
  User payload = 3;
  google.protobuf.Timestamp updated_at = 4;
  string trace_id = 5;
  map<string,string> metadata = 6;
}

```

### Ошибки

| Пункт алгоритма | Поле              | Ошибка                     | Сообщение                                                     | HTTP-код ошибки |
| --------------- | ----------------- | -------------------------- | ------------------------------------------------------------- | --------------- |
| 1.1             | login             | Дублирующее значение       | "Пользователь с таким логином уже существует"                 | 409             |
| 1.2             | email             | Дублирующее значение       | "Пользователь с таким email уже зарегистрирован"              | 409             |
| 3               | Все поля записи   | Ошибка вставки в БД        | "Не удалось добавить пользователя в базу данных"              | 500             |
| 4               | HTTP-ответ        | Ошибка формирования ответа | "Не удалось сформировать HTTP-ответ"                          | 500             |
| 5               | idempotency_key   | Ошибка записи в кэш        | "Не удалось сохранить ответ запроса с ключом идемпотентности" | 500             |
| 6               | Сообщение брокера | Ошибка отправки сообщения  | "Не удалось отправить сообщение в брокер событий"             | 502             |

